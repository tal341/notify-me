<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>⏰ תזכורות חכמות</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="https://img.icons8.com/ios-filled/50/000000/alarm.png">

<!-- ==== עיצוב ==== -->
<style>
:root{
    --bg:#1e1e2f;          /* רקע כהה */
    --card:#2a2a3d;        /* כרטיסים */
    --accent:#00ff88;      /* צבע מודגש */
    --text:#e0e0ff;        /* טקסט */
    --radius:12px;
    --shadow:0 4px 12px rgba(0,0,0,.4);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
    font-family:system-ui,Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:var(--text);
    line-height:1.5;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:2rem 1rem;
}
.container{
    width:100%;
    max-width:560px;
}
h1{
    font-size:2.2rem;
    text-align:center;
    margin-bottom:1rem;
    color:var(--accent);
}
.card{
    background:var(--card);
    border-radius:var(--radius);
    padding:1.5rem;
    margin-bottom:1.5rem;
    box-shadow:var(--shadow);
}
input,select,textarea,button{
    width:100%;
    font-size:1rem;
    padding:.8rem 1rem;
    margin-top:.5rem;
    border:none;
    border-radius:var(--radius);
}
input,select,textarea{
    background:#3a3a5a;
    color:#fff;
}
button{
    background:var(--accent);
    color:#000;
    font-weight:bold;
    cursor:pointer;
    transition:transform .1s;
}
button:hover{transform:scale(1.02);}
button:active{transform:scale(.98);}
.small{font-size:.9rem;}
.mt{margin-top:1rem;}
.center{text-align:center;}
#songPreview{
    margin-top:.8rem;
    text-align:center;
}
#songPreview audio{
    width:100%;
    margin-top:.4rem;
}
#messagePreview{
    margin-top:.8rem;
    padding:.6rem;
    background:#3a3a5a;
    border-radius:var(--radius);
    font-style:italic;
}
@media (max-width:480px){
    h1{font-size:1.8rem;}
}
</style>
</head>

<body>
<div class="container">

    <h1>⏰ תזכורות חכמות</h1>

    <!-- ====================  טופס יצירת תזכורת ==================== -->
    <div class="card">
        <h2 class="small">🗒️ שם & זמן</h2>
        <input id="title" type="text" placeholder="שם התזכורת (לדוגמה: לקחת תרופה)" required>
        <input id="time" type="time" required>

        <h2 class="small mt">🎵 שיר (או קישור MP3)</h2>
        <input id="songQuery" type="text" placeholder="חפש בי‑טוב (YouTube) או הדבק קישור MP3">
        <button id="searchBtn" class="small">🔎 חפש שיר</button>

        <div id="songPreview"></div>

        <h2 class="small mt">⏱️ קטע מהשיר (אופציונלי)</h2>
        <div class="small">הזנת זמן בפורמט <b>mm:ss</b> – לדוגמה 00:30 (30 שניות)</div>
        <input id="startSec" type="text" placeholder="התחלה (mm:ss)" class="small">
        <input id="endSec"   type="text" placeholder="סיום (mm:ss)" class="small">

        <h2 class="small mt">💬 הודעה מותאמת</h2>
        <textarea id="msg" rows="2" placeholder="הודעה שתופיע (אם ריק – נוצרה הודעה אוטומטית)"></textarea>
        <select id="msgStyle" class="small">
            <option value="normal">רגילה</option>
            <option value="funny">הומוריסטית</option>
            <option value="motiv">מעודדת</option>
        </select>
        <div id="messagePreview"></div>

        <button id="addBtn" class="mt">✨ הוסף תזכורת</button>
    </div>

    <!-- ====================  רשימת תזכורות ==================== -->
    <div class="card">
        <h2 class="small">📋 תזכורות פעילות</h2>
        <div id="list"></div>
    </div>

</div>

<!-- ==== קוד JavaScript ==== -->
<script>
/* ====================  קבועים והגדרות ==================== */
const YT_API_KEY = '';               // <-- הכנס כאן מפתח YouTube Data API (חינם) אם תרצה חיפוש אמיתי
const YT_SEARCH_URL = 'https://www.googleapis.com/youtube/v3/search';
const YT_VIDEO_URL  = 'https://www.youtube.com/embed/';   // embed id
const STORAGE_KEY = 'smartReminders';
let reminders = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

/* ====================  עזרי זמן ==================== */
function toSec(str){                     // "mm:ss" → שניות
    const [m,s] = str.split(':').map(Number);
    return (isNaN(m)?0:m)*60 + (isNaN(s)?0:s);
}
function toMMSS(sec){
    const m = Math.floor(sec/60).toString().padStart(2,'0');
    const s = (sec%60).toString().padStart(2,'0');
    return `${m}:${s}`;
}

/* ====================  הודעות AI (פשוט) ==================== */
function generateMessage(title, style){
    const base = `היי! הגיע הזמן ל‑${title}.`;
    if(style==='funny')   return `${base} 😆 אל תתן לשעון לשקר אותך!`;
    if(style==='motiv')   return `${base} 💪 תזכור – כל צעד קטן מוביל להצלחה!`;
    return base; // normal
}

/* ====================  חיפוש שיר בי‑טוב ==================== */
async function searchYouTube(query){
    if(!YOUTUBE_API_KEY){
        // ללא מפתח – נציג הודעה למשתמש
        alert('אין מפתח YouTube API – חיפוש אינו זמין. ניתן להדביק קישור MP3 ישירות.');
        return;
    }
    const url = `${YT_SEARCH_URL}?part=snippet&type=video&maxResults=5&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
    const resp = await fetch(url);
    const data = await resp.json();
    return data.items.map(v=>({id:v.id.videoId, title:v.snippet.title}));
}

/* ====================  הצגת תוצאות חיפוש ==================== */
async function handleSearch(){
    const q = document.getElementById('songQuery').value.trim();
    if(!q) return;
    const preview = document.getElementById('songPreview');
    preview.innerHTML = '<p class="small">מחפש…</p>';

    // אם הקישור הוא MP3 ישיר – נציג ישירות
    if(q.match(/\.(mp3|wav|ogg)(\?.*)?$/i)){
        preview.innerHTML = `
            <audio controls src="${q}"></audio>
            <button class="small" onclick="selectSong('${q}','קובץ MP3')">בחר קובץ זה</button>
        `;
        return;
    }

    // חיפוש בי‑טוב (אם יש מפתח)
    const results = await searchYouTube(q);
    if(results.length===0){
        preview.innerHTML = '<p class="small">לא נמצאו תוצאות.</p>';
        return;
    }
    preview.innerHTML = results.map(r=>`
        <div class="small" style="margin:.4rem 0;">
            <b>${r.title}</b><br>
            <iframe width="100%" height="80" src="${YT_VIDEO_URL}${r.id}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            <button class="small" onclick="selectSong('${r.id}','${r.title.replace(/'/g,"\\'")}')">בחר</button>
        </div>
    `).join('');
}

/* ====================  בחירת שיר ==================== */
let selectedSong = null;   // {type:'yt'|'url', id:..., title:...}
function selectSong(idOrUrl, title){
    if(idOrUrl.startsWith('http')){ // MP3 url
        selectedSong = {type:'url', url:idOrUrl, title};
    }else{
        selectedSong = {type:'yt', id:idOrUrl, title};
    }
    const preview = document.getElementById('songPreview');
    preview.innerHTML = `<p class="small">נבחר: ${title}</p>`;
}

/* ====================  תצוגת הודעה מותאמת ==================== */
document.getElementById('msg').addEventListener('input', updateMsgPreview);
document.getElementById('msgStyle').addEventListener('change', updateMsgPreview);
function updateMsgPreview(){
    const txt = document.getElementById('msg').value.trim();
    const style = document.getElementById('msgStyle').value;
    const title = document.getElementById('title').value.trim()||'התזכורת';
    const out = txt || generateMessage(title, style);
    document.getElementById('messagePreview').textContent = out;
}

/* ====================  הוספת תזכורת ==================== */
document.getElementById('addBtn').addEventListener('click', addReminder);
function addReminder(){
    const title   = document.getElementById('title').value.trim();
    const timeStr = document.getElementById('time').value;
    const msgRaw  = document.getElementById('msg').value.trim();
    const style   = document.getElementById('msgStyle').value;
    const start   = toSec(document.getElementById('startSec').value);
    const end     = toSec(document.getElementById('endSec').value);

    if(!title || !timeStr){
        alert('הכנס שם וזמן.');
        return;
    }
    if(!selectedSong){
        alert('בחר שיר או הדבק קישור MP3.');
        return;
    }

    const now = new Date();
    const [h,m] = timeStr.split(':').map(Number);
    const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0, 0);
    // אם הזמן כבר עבר היום – קבע ליום הבא
    if(target <= now) target.setDate(target.getDate()+1);
    const delay = target.getTime() - now.getTime();

    const reminder = {
        id: Date.now(),
        title,
        time: timeStr,
        target: target.getTime(),
        msg: msgRaw || generateMessage(title, style),
        song: selectedSong,
        start,
        end,
        active:true
    };
    reminders.push(reminder);
    saveReminders();
    renderList();
    schedule(reminder, delay);
    clearForm();
}

/* ====================  שמירת/טעינת תזכורות ==================== */
function saveReminders(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders));
}

/* ====================  רינדור רשימת תזכורות ==================== */
function renderList(){
    const list = document.getElementById('list');
    if(reminders.length===0){
        list.innerHTML = '<p class="small">אין תזכורות פעילות.</p>';
        return;
    }
    list.innerHTML = reminders.map(r=>`
        <div class="small" style="margin:.6rem 0; padding:.6rem; background:#3a3a5a; border-radius:var(--radius);">
            <b>${r.title}</b> – ${new Date(r.target).toLocaleTimeString('he-IL', {hour:'2-digit',minute:'2-digit'})}
            <br>הודעה: ${r.msg}
            <br>שיר: ${r.song.title}
            <br><button class="small" onclick="deleteReminder(${r.id})">🗑️ מחק</button>
        </div>
    `).join('');
}

/* ====================  מחיקת תזכורת ==================== */
function deleteReminder(id){
    reminders = reminders.filter(r=>r.id!==id);
    saveReminders();
    renderList();
}

/* ====================  ניקוי טופס ==================== */
function clearForm(){
    document.getElementById('title').value='';
    document.getElementById('time').value='';
    document.getElementById('songQuery').value='';
    document.getElementById('songPreview').innerHTML='';
    document.getElementById('msg').value='';
    document.getElementById('msgStyle').value='normal';
    document.getElementById('messagePreview').innerHTML='';
    document.getElementById('startSec').value='';
    document.getElementById('endSec').value='';
    selectedSong=null;
}

/* ====================  תזמון התראה ==================== */
function schedule(rem, delay){
    // אם הדפדפן סגור – נשתמש ב‑setTimeout רק בזמן פתוח.
    // במצב של GitHub Pages זה מספיק.
    setTimeout(()=>showNotification(rem), delay);
}

/* ====================  הצגת התראה ==================== */
async function showNotification(rem){
    // 1️⃣ בקשת הרשאה (מתבצעת רק בפעם הראשונה)
    if(Notification.permission!=='granted'){
        await Notification.requestPermission();
    }

    // 2️⃣ יצירת ההתראה
    const notif = new Notification(rem.title, {
        body: rem.msg,
        icon: 'https://img.icons8.com/ios-filled/50/000000/alarm.png'
    });

    // 3️⃣ נגן את השיר (או קטע ממנו)
    const audio = new Audio();
    if(rem.song.type==='url'){
        audio.src = rem.song.url;
    }else{
        // YouTube embed – נשתמש ב‑YouTube Iframe API כדי לקבל קובץ MP3?
        // הפתרון הפשוט: נשתמש ב‑youtube-nocookie.com עם autoplay ו‑start/end
        const start = rem.start||0;
        const end   = rem.end||0;
        const src = `https://www.youtube.com/embed/${rem.song.id}?autoplay=1&start=${start}&end=${end}&controls=0`;
        audio.src = src; // זה יפעל רק במכשירי מובייל עם אפשרות autoplay
    }
    audio.volume = 0.7;
    audio.play().catch(()=>{}); // במידה שהדפדפן חוסם autoplay

    // 4️⃣ כפתור "הבנתי" – סוגר את ההתראה
    notif.onclick = ()=>{ notif.close(); audio.pause(); };
}

/* ====================  אתחול ראשוני ==================== */
function init(){
    // אם יש תזכורות שמיועדות לעתיד – נזמן אותן מחדש
    const now = Date.now();
    reminders.forEach(r=>{
        if(r.active && r.target>now){
            schedule(r, r.target-now);
        }
    });
    renderList();
}
init();

/* ====================  אירועי לחצנים ==================== */
document.getElementById('searchBtn').addEventListener('click', handleSearch);
</script>
</body>
</html>
