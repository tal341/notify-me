<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>â° ×ª×–×›×•×¨×•×ª ×—×›××•×ª</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1e1e2f;
            color: white;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container { max-width: 600px; width: 100%; }
        .card {
            background: #2a2a3d;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        input, textarea, button {
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
        }
        button {
            background: #00ff88;
            color: black;
            font-weight: bold;
            cursor: pointer;
        }
        button:hover { opacity: 0.8; }
        .reminder {
            background: #3a3a5a;
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â° ×ª×–×›×•×¨×•×ª ×—×›××•×ª</h1>

        <div class="card">
            <input id="title" placeholder="×©× ×”×ª×–×›×•×¨×ª">
            <input id="time" type="time">
            <input id="date" type="date">
            <textarea id="msg" placeholder="×”×•×“×¢×” ×©×ª×•×¤×™×¢"></textarea>

            <h3>ğŸµ ×—×¤×© ×©×™×¨ (×‘×™×©×•×)</h3>
            <input id="songQuery" placeholder="×”×›× ×¡ ×©× ×©×™×¨">
            <button onclick="searchSong()">ğŸ” ×—×¤×© ×©×™×¨</button>
            <div id="songResults"></div>

            <h3>â±ï¸ ×§×˜×¢ ××”×©×™×¨ (××•×¤×¦×™×•× ×œ×™)</h3>
            <input id="startSec" placeholder="×”×ª×—×œ×” (mm:ss)" style="width:45%">
            <input id="endSec" placeholder="×¡×™×•× (mm:ss)" style="width:45%">

            <h3>ğŸ”Š ×¢×•×¦××”</h3>
            <label>×¢×•×¦××”: <span id="volVal">70%</span></label>
            <input id="volume" type="range" min="0" max="100" value="70">

            <button onclick="addReminder()">â• ×”×•×¡×£ ×ª×–×›×•×¨×ª</button>
        </div>

        <div class="card">
            <h3>ğŸ“‹ ×ª×–×›×•×¨×•×ª ×¤×¢×™×œ×•×ª</h3>
            <div id="list"></div>
        </div>
    </div>

    <script>
        const YOUTUBE_API_KEY = 'AIzaSyBDGwqcOIqo3vaYXhBBum4gotp9ltLXo14'; // <-- API KEY ×©×œ×š
        let reminders = JSON.parse(localStorage.getItem("reminders") || "[]");

        function save() { localStorage.setItem("reminders", JSON.stringify(reminders)); }

        function render() {
            const div = document.getElementById("list");
            if (reminders.length === 0) { div.innerHTML = "××™×Ÿ ×ª×–×›×•×¨×•×ª"; return; }
            div.innerHTML = "";
            reminders.forEach(r => {
                const d = document.createElement("div");
                d.className = "reminder";
                d.innerHTML = `<b>${r.title}</b> | ${r.date} ${r.time}<br>${r.msg}`;
                div.appendChild(d);
            });
        }

        async function searchSong() {
            const query = document.getElementById("songQuery").value.trim();
            if (!query) return;

            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=5&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();

                const resultsDiv = document.getElementById("songResults");
                if (data.items && data.items.length > 0) {
                    resultsDiv.innerHTML = data.items.map(item => {
                        const videoId = item.id.videoId;
                        const title = item.snippet.title;
                        const thumbnail = item.snippet.thumbnails.default.url;
                        return `
                            <div style="margin:10px 0; padding:10px; background:#3a3a5a; border-radius:8px;">
                                <img src="${thumbnail}" alt="thumbnail" style="width:80px; float:left; margin-right:10px;">
                                <div>
                                    <b>${title}</b><br>
                                    <button onclick="selectSong('${videoId}', '${title}')">×‘×—×¨</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    resultsDiv.innerHTML = "<p>×œ× × ××¦××• ×ª×•×¦××•×ª.</p>";
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×—×™×¤×•×©:', error);
                document.getElementById("songResults").innerHTML = "<p>×©×’×™××” ×‘×—×™×¤×•×©. × ×¡×” ×©×•×‘.</p>";
            }
        }

        let selectedSong = null;

        function selectSong(videoId, title) {
            selectedSong = { id: videoId, title };
            document.getElementById("songResults").innerHTML = `<p>× ×‘×—×¨: ${title}</p>`;
        }

        function addReminder() {
            const title = document.getElementById("title").value.trim();
            const time = document.getElementById("time").value;
            const date = document.getElementById("date").value;
            const msg = document.getElementById("msg").value.trim() || `×–××Ÿ ×œ: ${title}`;
            const start = parseTime(document.getElementById("startSec").value);
            const end = parseTime(document.getElementById("endSec").value);
            const volume = document.getElementById("volume").value / 100;

            if (!title || !time || !date) {
                alert("××œ× ×©×, ×ª××¨×™×š ×•×©×¢×”");
                return;
            }

            const target = new Date(`${date}T${time}:00`).getTime();
            const delay = target - Date.now();

            const reminder = {
                id: Date.now(),
                title,
                date,
                time,
                msg,
                song: selectedSong,
                start,
                end,
                volume,
                target,
                active: true
            };

            reminders.push(reminder);
            save();
            render();

            if (delay > 0) setTimeout(() => notify(reminder), delay);
            else alert("×”×–××Ÿ ×¢×‘×¨...");

            clearForm();
        }

        function parseTime(str) {
            if (!str) return 0;
            const [m, s] = str.split(':').map(Number);
            return (isNaN(m) ? 0 : m) * 60 + (isNaN(s) ? 0 : s);
        }

        function notify(r) {
            if (!r.active) return;

            // ×”×ª×¨××” ×“×¤×“×¤×Ÿ
            if ("Notification" in window) {
                if (Notification.permission === "granted")
                    new Notification(r.title, { body: r.msg });
                else if (Notification.permission !== "denied")
                    Notification.requestPermission().then(p => {
                        if (p === "granted") new Notification(r.title, { body: r.msg });
                    });
            }

            // ×¦×œ×™×œ
            if (r.song) {
                const audio = new Audio(`https://www.youtube.com/embed/${r.song.id}?autoplay=1&start=${r.start}&end=${r.end}`);
                audio.volume = r.volume;
                audio.play().catch(e => {
                    console.log("×œ× × ×™×ª×Ÿ ×œ× ×’×Ÿ: ", e);
                    // ×× ×œ× ×¢×•×‘×“ â€“ × × ×¡×” ×¦×œ×™×œ ×‘×¨×™×¨×ª ××—×“×œ
                    const beep = new Audio("https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3");
                    beep.volume = r.volume;
                    beep.play();
                });
            } else {
                const beep = new Audio("https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3");
                beep.volume = r.volume;
                beep.play();
            }

            r.active = false;
            save();
            render();
        }

        function clearForm() {
            document.getElementById("title").value = "";
            document.getElementById("songQuery").value = "";
            document.getElementById("songResults").innerHTML = "";
            document.getElementById("startSec").value = "";
            document.getElementById("endSec").value = "";
            document.getElementById("volume").value = 70;
            document.getElementById("volVal").textContent = "70%";
            selectedSong = null;
        }

        document.getElementById("volume").oninput = e => {
            document.getElementById("volVal").textContent = e.target.value + "%";
        };

        function init() {
            render();
            reminders.forEach(r => {
                if (r.active) {
                    const delay = r.target - Date.now();
                    if (delay > 0) setTimeout(() => notify(r), delay);
                }
            });
        }

        init();
    </script>
</body>
</html>
